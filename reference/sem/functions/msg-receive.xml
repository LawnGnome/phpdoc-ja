<?xml version="1.0" encoding="utf-8"?>
<!-- $Revision: 1.1 $ -->
<!-- EN-Revision: 1.7 Maintainer: takagi Status: ready -->
  <refentry id="function.msg-receive">
   <refnamediv>
    <refname>msg_receive</refname>
    <refpurpose>
     メッセージキューからメッセージを受信する
    </refpurpose>
   </refnamediv>
   <refsect1>
    <title>Description</title>
    <methodsynopsis>
     <type>bool</type><methodname>msg_receive</methodname>
     <methodparam><type>resource</type><parameter>queue</parameter></methodparam>
     <methodparam><type>int</type><parameter>desiredmsgtype</parameter></methodparam>
     <methodparam><type>int</type><parameter role="reference">msgtype</parameter></methodparam>
     <methodparam><type>int</type><parameter>maxsize</parameter></methodparam>
     <methodparam><type>mixed</type><parameter role="reference">message</parameter></methodparam>
     <methodparam choice="opt"><type>bool</type><parameter>unserialize</parameter></methodparam>
     <methodparam choice="opt"><type>int</type><parameter>flags</parameter></methodparam>
     <methodparam choice="opt"><type>int</type><parameter role="reference">errorcode</parameter></methodparam>
    </methodsynopsis>
    <para>
     <function>msg_receive</function> は、指定した <parameter>queue</parameter>
     から指定した <parameter>desiredmsgtype</parameter> の最初の
     メッセージを受信します。
     受信したメッセージの型が <parameter>msgtype</parameter> に保存されます。
     読み込むメッセージの最大サイズは <parameter>maxsize</parameter>
     で指定します。もしキューにあるメッセージのサイズがこれより大きい場合、
     (以下で説明する <parameter>flags</parameter> が設定されていない限り)
     この関数は失敗します。エラーが発生しなければ、
     受信したメッセージは <parameter>message</parameter> に保存されます。
     エラーが発生した場合は、オプションの <parameter>errorcode</parameter>
     にシステムの errno 値が設定されます。これはエラーの原因を特定するために
     有用です。
    </para>
    <para>
     <parameter>desiredmsgtype</parameter> が 0 の場合、キューの先頭にある
     メッセージが返されます。<parameter>desiredmsgtype</parameter> が 0
     より大きな値の場合、その型のメッセージのうち一番最初にあるものが
     返されます。<parameter>desiredmsgtype</parameter> が 0 より小さな値の
     場合、<parameter>desiredmsgtype</parameter> の絶対値と同じかそれより
     小さい型のメッセージのうち一番最初にあるものが返されます。
     条件を満たすメッセージがない場合は、条件を満たすメッセージがキューに
     投入されるまで待ち続けます。パラメータ <parameter>flags</parameter>
     に <constant>MSG_IPC_NOWAIT</constant> を指定することで、
     ブロックモードではなくすることが可能です。
    </para>
    <para>
     <parameter>unserialize</parameter> のデフォルト値は &true; です。
     このパラメータが &true; に設定されている場合、メッセージは
     セッションモジュールと同様の方法でシリアライズされているものと
     みなされます。メッセージは元の状態に復元されたうえでスクリプトに
     返されます。これにより、配列やオブジェクト構造体のような複雑な
     形式のデータを他の PHP スクリプトから簡単に受信することが可能となります。
     また、もし WDDX シリアライザを使用しているなら、あらゆる WDDX
     互換のソースからデータを受け取ることが可能となります。
     <parameter>unserialize</parameter> が &false; の場合、メッセージは
     バイナリセーフな文字列として返されます。
    </para>
    <para>
     オプションの <parameter>flags</parameter> により、低レベルの
     msgrcv システムコールにフラグを渡すことが可能です。デフォルト値は 0
     ですが、以下の値のうちのいくつかを(値を足すかあるいは論理和ととることで)
     指定することが可能です。
     <table>
      <title>msg_receive のフラグの値</title>
      <tgroup cols="2">
       <tbody>
        <row>
         <entry><constant>MSG_IPC_NOWAIT</constant></entry> 
         <entry>
          <parameter>desiredmsgtype</parameter> を満たすメッセージが
          存在しない場合に、待ち続けずにすぐに結果を返します。
          関数は失敗し、ENOMSG に対応する整数値を返します。
         </entry>
        </row>
        <row>
         <entry><constant>MSG_EXCEPT</constant></entry>
         <entry>
          このフラグを正の <parameter>desiredmsgtype</parameter>
          と組み合わせて使用すると、この関数は
          <parameter>desiredmsgtype</parameter> 以外の型をもつ
          最初のメッセージを受信するようになります。
         </entry>
        </row>
        <row>
         <entry><constant>MSG_NOERROR</constant></entry> 
         <entry>
          このフラグを設定しておくと、メッセージが
          <parameter>maxsize</parameter> より大きい場合に
          そのメッセージを <parameter>maxsize</parameter> までに切り詰め、
          エラーを返しません。
         </entry>
        </row>
       </tbody>
      </tgroup>
     </table>
    </para>
    <para>
     処理が正常に完了すると、メッセージキューデータ構造体は以下のように更新されます。
     <literal>msg_lrpid</literal> には呼び出し元のプロセス ID が
     設定され、<parameter>msg_qnum</parameter> が 1 減少し、
     <literal>msg_rtime</literal> が現在の時刻に設定されます。
    </para>
    <para>
     <function>msg_receive</function> は、成功した場合に &true;、
     失敗した場合に &false; を返します。関数が失敗した場合、オプションの
     <parameter>errorcode</parameter> にシステムの errno 値が設定されます。
    </para>
    <para>
     <function>msg_remove_queue</function>、
     <function>msg_send</function>、
     <function>msg_stat_queue</function> および
     <function>msg_set_queue</function> も参照ください。
    </para>
   </refsect1>
  </refentry>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"../../../../manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
