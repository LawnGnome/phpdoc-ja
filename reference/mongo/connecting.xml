<?xml version="1.0" encoding="utf-8"?>
<!-- $Revision$ -->
<!-- EN-Revision: 305112 Maintainer: takagi Status: ready -->

<section xml:id="mongo.connecting" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">
 <title>接続</title>

 <para>
  MongoDB への接続は単に <literal>new Mongo</literal> とするだけの簡単なものですが、
  オプションや設定項目が多数あります。
  <function>Mongo::__construct</function> のページにすべての API
  オプションをまとめましたが、ここではより実用的な使用例をとりあげます。
 </para>

 <section>
  <title>接続時のログイン</title>
  <para>
   MongoDB を <literal>--auth</literal> オプションつきで起動すると、
   接続時の認証が必須となります。データベース単位でこれを設定するには
   <function>MongoDB::authenticate</function> を使います。
  </para>
  <programlisting role="php">
<![CDATA[
<?php

$m = new Mongo();
$db = $m->admin;

$db->authenticate($username, $password);

?>
]]>
  </programlisting>
  <para>
   この方法には大きな弱点があります。
   データベースとの接続が切れてしまってから再接続をしたときには、
   認証されていない状態になってしまうということです。
  </para>
  <para>
   <function>Mongo::__construct</function> で説明した接続文字列形式を使えば、
   接続を再確立したときにも再び認証を行うことができます。
  </para>
  <para>
   これは上のコードと同じ意味ですが、
   再接続したときにも自動的に認証を行います。
  </para>
  <programlisting role="php">
<![CDATA[
<?php

$m = new Mongo("mongodb://${username}:${password}@localhost");

?>
]]>
  </programlisting>
  <para>
   デフォルトでは、ユーザの認証は admin データベースに対して行います。
   別のデータベースへの認証を行うには、ホスト名のあとにデータベース名を指定します。
   この例は、"blog" データベースにログインします。
  </para>
  <programlisting role="php">
<![CDATA[
<?php

$m = new Mongo("mongodb://${username}:${password}@localhost/blog");

?>
]]>
  </programlisting>
 </section>

 <section>
  <title>レプリカセット</title>
  <para>
   レプリカセットに接続するには、セットに属するサーバをひとつ以上指定して、
   さらに <literal>replicaSet</literal> オプションを使います。
  </para>
  <programlisting role="php">
<![CDATA[
<?php

$m = new Mongo("mongodb://localhost:27017", array("replicaSet" => true));

?>
]]>
  </programlisting>
  <para>
   バージョン 1.0.9 以降のドライバでは、レプリカセットへの接続が必須となります
   (それより前のバージョンでは、マスタの自動検出や再接続が正しく動作しません)。
  </para>
  <para>
   PHP ドライバは、指定したサーバ群に問い合わせてどれがマスタなのかを調べます。
   リストにあげたサーバのうち少なくともひとつに接続でき、
   マスタが見つかってさえいれば接続が成功したとみなされます。
   どのサーバにも接続できない、あるいはマスタが見つからないといった場合は
   <classname>MongoConnectionException</classname> がスローされます。
  </para>
  <para>
   マスタが使えなくなったときに、スレーブがマスタになるには数秒かかります。
   その間は、この接続では一切のデータベース操作ができなくなります
   (スレーブに接続して読み込みを行うことは可能です)。
   したがって、このときに何らかの読み書き操作をすると例外が発生します。
  </para>
  <para>
   新しいマスタが選ばれると、読み込みや書き込みの操作時にドライバが新しいマスタを検出できるようになります。
   そして、ドライバがデータベース接続を切り替えて通常の操作を続行できるようになります。
  </para>
  <para>
   レプリカセットについての詳細は、
   <link xlink:href="&url.mongodb.replica;">コアドキュメント</link>
   を参照ください。
  </para>
 </section>

 <section>
  <title>分散読み込み</title>
  <para>
   レプリカセットの使いかたのひとつとして、
   読み込みをスレーブから行うようにしてマスタの負荷を軽減させるという方法があります。
   これはドライバが自動で行うものではないので、自分で設定することになります。
  </para>
  <para>
   まず、<literal>replicaSet</literal> オプションを指定してレプリカセットに接続します。
   これで、レプリカセットのマスタへの接続が得られます。
   この接続で <literal>ismaster</literal> コマンドをコールすると、
   レプリカセットのすべてのスレーブの一覧を取得できます。
  </para>
  <programlisting role="php">
<![CDATA[
<?php

$m = new Mongo("mongodb://localhost:27017", array("replicaSet" => true));
$result = $m->admin->command(array("ismaster" => 1));

?>
]]>
  </programlisting>
  <para>
   次に、"hosts" フィールドおよび "passives" フィールドにあげられたホストへの接続を作成します
   (passives とは、セットのメンバーの中で決してマスタになることがないものです)。
   このときには <literal>replicaSet =&gt; true</literal> を指定しません。
   (指定してしまうと、マスタを探して自動的にマスタへの接続に切り替えられてしまいます)。
   これらの接続を使い分けると、読み込みを分散させることができます。
   スレーブからの読み込みを行う前には
   <literal>MongoCursor::slaveOkay</literal> を &true; に設定しておくことを忘れないようにしましょう。
  </para>
 </section>

 <section>
  <title>持続的接続</title>

  <para>
   データベースへの接続を新たに確立させるには、非常に時間がかかります。
   データベースへ接続の作成回数を最小限にするには、持続的接続を使うことができます。
   持続的接続は PHP が保持するので、同じ接続を使って複数のリクエストを送ることができます。
  </para>

  <para>
   たとえば、この単純なプログラムはデータベースに 1000 回接続します。
  </para>

  <programlisting role="php">
<![CDATA[
<?php

for ($i=0; $i<1000; $i++) {
  $m = new Mongo();
}

?>
]]>
  </programlisting>

  <para>
   実行時間は約 18 秒です。これを、持続的接続を使うように変更してみましょう。
  </para>

  <programlisting role="php">
<![CDATA[
<?php

for ($i=0; $i<1000; $i++) {
  $m = new Mongo("localhost:27017", array("persist" => "x"));
}

?>
]]>
  </programlisting>

  <para>
   実行時間は .02 秒未満になりました。データベースへの接続は 1 回だけしか行わないからです。
  </para>

  <para>
   持続的接続には識別用の文字列 (上の例では "x")
   が必要で、これを使って接続を識別します。
   持続的接続を使うには、ホスト名とポート、持続文字列、そしてユーザ名とパスワード(指定した場合)
   が既存の持続的接続と一致しなければなりません。
   一致しない場合は、この識別情報で新しい接続を作成します。
  </para>
  <para>
   持続的接続を使うことを<emphasis>強く推奨します</emphasis>。
   実運用環境では、やむを得ぬ理由がない限り常に持続的接続を使うべきです。
   リレーショナルデータベースにおいて持続的接続を推奨しない理由はいくつかありますが、
   その大半は MongoDB には無関係なものです。
  </para>
  <para>
   持続的接続は、1.0.12 でデフォルトの接続方式になりました。
   持続的でない接続を作成するには、
   <literal>"persist" =&gt; false</literal> を
   <function>Mongo::__construct</function> に渡さなければなりません。
  </para>
 </section>

 <section>
  <title>ドメインソケット</title>

  <para>
   MongoDB をローカルで動かしていてバージョン 1.0.9
   以降のドライバを使っている場合は、ファイル経由でデータベースに接続することができます。
   MongoDB は、起動時に自動的にソケットファイル
   /tmp/mongodb-&lt;port&gt;.sock をオープンします。
  </para>

  <para>
   ソケットファイルに接続するには、このパスを MongoDB 接続文字列に指定します。
  </para>

  <programlisting role="php">
<![CDATA[
<?php

$m = new Mongo("mongodb:///tmp/mongo-27017.sock");

?>
]]>
  </programlisting>

  <para>
   上で示したようなソケットファイルへの接続で認証を使いたい場合は、
   ポート番号 0 を指定しなければなりません。
   接続文字列のパーサは、これを接続文字列の終端と見なします。
  </para>

  <programlisting role="php">
<![CDATA[
<?php

$m = new Mongo("mongodb://username:password@/tmp/mongo-27017.sock:0/foo");

?>
]]>
  </programlisting>

 </section>

</section>
