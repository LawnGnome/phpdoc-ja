<?xml version="1.0" encoding="utf-8"?>
<!-- $Revision: 1.1 $ -->
<!-- EN-Revision: 1.5 Maintainer: hirokawa Status: working -->
<chapter id="security.magicquotes">
  <title>マジッククオート</title>

  <para>
   マジッククオートは、PHPスクリプトに入力されるデータを
   自動的にエスケープする機能です。
   コードでは、マジッククオートをオフにして
   実行する際必要な時にデータをエスケープすることが望まれます。
  </para>
  
  <sect1 id="security.magicquotes.what">
   <title>マジッククオートとは</title>
   <para>
    オンの場合、全ての<literal>'</literal> (シングルクオート), <literal>"</literal> 
    (ダブルクオート), <literal>\</literal> (バックスラッシュ)および<literal>NULL</literal> 
    文字がバックスラッシュで自動的にエスケープされます。
    これは、<function>addslashes</function> の機能と同じです。
   </para>
   <para>
    3種類のマジッククオートディレクティブを以下に示します。
   </para>
   <itemizedlist>
    <listitem>
     <simpara>
      <link linkend="ini.magic-quotes-gpc">magic_quotes_gpc</link>
     </simpara>
     <simpara>
      HTTPリクエストデータ(GET, POST, そして COOKIE)に作用します。
      実行時に設定することはできません。
      PHPの出フォルトは、<emphasis>on</emphasis>です。
     </simpara>
     <simpara>
      <function>get_magic_quotes_gpc</function>も参照して下さい。
     </simpara>
    </listitem>
    <listitem>
     <simpara>
      <link linkend="ini.magic-quotes-runtime">magic_quotes_runtime</link>
     </simpara>
     <simpara>
      有効な場合、データベースやテキストファイルを含む
      外部ソースからデータを返す関数の多くは、
      バックスラッシュをクオートでエスケープします。
      実行時に設定することができ、PHPでのデフォルトは
      <emphasis>on</emphasis>です。
     </simpara>
     <simpara>
      <function>set_magic_quotes_runtime</function>および
      <function>get_magic_quotes_runtime</function>も参照して下さい。
     </simpara>
    </listitem>
    <listitem>
     <simpara>
      <link linkend="ini.magic-quotes-sybase">magic_quotes_sybase</link>
     </simpara>
     <simpara>
      有効な場合、シングルクオートはバックスラッシュではなくシングルクオートで
      エスケープされます。 onの場合、
      <link linkend="ini.magic-quotes-gpc">magic_quotes_gpc</link>
      の指定を完全に上書きします。
      これら両方のディレクティブを有効にすると、シングルクオートは
      <literal>''</literal>とエスケープされます。
      ダブルクオートやNULLはそのままとなり、エスケープされません。
     </simpara>
     <simpara>
      この値を取得するには、
      <function>ini_get</function>も参照して下さい。
     </simpara>
    </listitem>
   </itemizedlist>
  </sect1>
  
  <sect1 id="security.magicquotes.why">
   <title>なぜマジッククオートを使用するのか</title>
   <itemizedlist>
    <listitem>
     <simpara>
      初心者にとって便利
     </simpara>
     <simpara>
      Magic quotes are implemented in PHP to help code written by beginners 
      from being dangerous. Although 
       <link linkend="security.database.sql-injection">SQL Injection</link> 
      is still possible with magic quotes on, the risk is reduced.
     </simpara>
    </listitem>
    <listitem>
     <simpara>
      便利
     </simpara>
     <simpara>
      For inserting data into a database, magic quotes essentially runs 
      <function>addslashes</function> on all Get, Post, and Cookie data,
      and does so automagically.
     </simpara>
    </listitem>
   </itemizedlist>
  </sect1>
  
   <sect1 id="security.magicquotes.whynot">
   <title>なぜマジッククオートを使用しないのか</title>
   <itemizedlist>
    <listitem>
     <simpara>
      移植性
     </simpara>
     <simpara>
      Assuming it to be on, or off, affects portability. Use
      <function>get_magic_quotes_gpc</function> to check for this, and code
      accordingly.
      </simpara>
    </listitem>
    <listitem>
     <simpara>
      性能
     </simpara>
     <simpara>
      Because not every piece of escaped data is inserted into a 
      database, there is a performance loss for escaping all this data. 
      Simply calling on the escaping functions (like 
      <function>addslashes</function>) at runtime is more efficient.
     </simpara>
     <simpara>
      Although <filename>php.ini-dist</filename> enables these directives  
      by default, <filename>php.ini-recommended</filename> disables it.
      This recommendation is mainly due to performance reasons.
     </simpara>
     </listitem>
    <listitem>
     <simpara>
      不便
     </simpara>
     <simpara>
      Because not all data needs escaping, it's often annoying to see escaped
      data where it shouldn't be. For example, emailing from a form, and
      seeing a bunch of \' within the email. To fix, this may require 
      excessive use of <function>stripslashes</function>.
     </simpara>
    </listitem>
   </itemizedlist>
  </sect1>
  
  <sect1 id="security.magicquotes.disabling">
   <title>マジッククオートを無効にする</title>
   <para>
    The <link linkend="ini.magic-quotes-gpc">magic_quotes_gpc</link>
    directive may only be disabled at the system level, and not at
    runtime. In otherwords, use of <function>ini_set</function> is not
    an option.
   </para>
   <para>
    <example>
     <title>Disabling magic quotes server side</title>
     <para>
      An example that sets the value of these directives to 
      <literal>Off</literal> in &php.ini;.  For additional details, read the 
      manual section titled <link linkend="configuration.changes">How to 
       change configuration settings</link>.
     </para>
     <screen>
<![CDATA[
; Magic quotes
;

; Magic quotes for incoming GET/POST/Cookie data.
magic_quotes_gpc = Off

; Magic quotes for runtime-generated data, e.g. data from SQL, from exec(), etc.
magic_quotes_runtime = Off

; Use Sybase-style magic quotes (escape ' with '' instead of \').
magic_quotes_sybase = Off
]]>
     </screen>
     <para>
      If access to the server configuration is unavilable, use of
      <filename>.htaccess</filename> is also an option.  For example:
     </para>
     <screen>
<![CDATA[
php_flag magic_quotes_gpc Off
]]>
     </screen>
    </example>
   </para>
   <para>
    In the interest of writing portable code (code that works in any 
    environment), like if setting at the server level is not possible,
    here's an example to disable <link linkend="ini.magic-quotes-gpc">
     magic_quotes_gpc</link> at runtime. This method is inefficient so 
    it's preferred to instead set the appropriate directives elsewhere.
   </para>
   <para>
    <example>
     <title>マジッククオートを実行時に無効にする</title>
     <programlisting role="php">
<![CDATA[
<?php
if (get_magic_quotes_gpc()) {
    function stripslashes_deep($value)
    {
        $value = is_array($value) ?
                    array_map('stripslashes_deep', $value) :
                    stripslashes($value);

        return $value;
    }

    $_POST = array_map('stripslashes_deep', $_POST);
    $_GET = array_map('stripslashes_deep', $_GET);
    $_COOKIE = array_map('stripslashes_deep', $_COOKIE);
}
?>
]]>
     </programlisting>
    </example>
   </para>
  </sect1>
  
 </chapter>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"../../manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
